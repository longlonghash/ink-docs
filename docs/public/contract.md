---
title: 对智能合约的新思考
slug: /contract
---

先理解一下什么是智能合约，看一个典型的例子：可以往一个程序中存入一笔钱，由这个程序代码设定这笔钱一次能取多少，多长时间可以取一次，可作为小孩的零花钱，也可以作为对资金使用方式的严格控制。

### 肤浅且正确的认知
- 智能合约是部署在区块链系统（去中心化）上的一段程序代码，和部署在关系数据库（中心化）上的触发器非常相似。智能合约由用户发送一笔交易触发运行，或由其他智能合约触发运行，但最终的触发源还是来自于用户发送的交易；

- 智能合约是控制资金流转的一段代码程序，和其他的代码程序不一样的地方，就在于"控制资金流转"这几个字。因为这段代码的控制对象是资金，出于安全考虑，需要进行严格的检查与审核；

- 人们往往以智能合约是否为图灵完备划分区块链-2.0（以 Ethereum 为代表） 和 区块链-1.0（以 Bitcoin 为代表），这就是在玩一个概念游戏。中本聪在设计 Bitcoin 的堆栈式脚本语言时，难道想不到把这个脚本语言进一步强化，实现图灵完备的编程能力吗？不是想不到，而是故意不去做，不想把系统搞得很复杂，毕竟 Bitcoin 之前没有先例可以参考，当然设计的越简单，就越不会出现意想不到的坏结果（比如全网宕机）。以是否实现图灵完备的智能合约作为 1.0 和 2.0 的评判标准，可被认为是在故意弱化 Bitcoin 与中本聪的共享与影响力。

### 进一步思考智能合约
1、思考一下能合约的激发条件，不难发现条件范围可以拓展的更宽广一些，智能合约不一定要由交易触发运行，也可以定制一套时钟序列，并以其为周期，由矿工调度执行，但这需要合约账户本身可以支付 Gas 费，或者绑定一个付费账户。 例如：
- 每隔 10 个区块，自动调度运行；
- 没有交易（出空块）或交易数量较少时，自动调度调度运行。

2、智能合约应该可以调度一切原子功能，不要限制它的功能，这一点，我还未发现哪一个现有的公链考虑到了。智能合约，本质上是通过代码，以可编程的方式对公链提供的一切原子功能进行编排和调用，普通账户拥有的功能，合约账户都应该拥有，这会带来不可思议的神奇效果，例如：
- 执行 Staking 操作，想象一下，可以用一段自动化运行的代码，以去中心化的方式吸收参与者的资金去进行 Staking，是多么酷炫的一件事；
- 用户可以发送交易部署智能合约，那么智能合约本身也可以在按照设定好的计划，在合适的时候动态部署其他其他智能合约，这也是非常有趣的一件事。

3、智能合约可改进和优化的其他地方
- 智能合约的部署颗粒度可以降低一些，若以函数为基本的部署单元，许多项目就可以共享同一个函数，无需重复部署大量重复的函数代码；
- 智能合约更改账本状态的两种方案：1）智能合约可直接操纵 KeyValue DB，比如 Hyperledger-Fabric；2）智能合约看不到 KeyValue DB，编译器负责映射 Storage 变量到 KeyValue DB，比如 Ethereum Solidity；哪种方法更优秀呢？我觉得第1种更好，因为它给予开发者更大的自由度；
- 智能合约必须被每一个节点执行，那么执行代价必然昂贵，若允许智能合约自己设定不低于某个最小数量的 validators 重复执行并验证生效（需要公链本身可对不负责任或恶意的 validators 进行惩罚），则可实现更便宜、更灵活的计费策略；
- 以太坊的区块平均间隔，大概 15 秒左右，从而导致一个区块中的所有智能合约的执行时间之和不能超过 15 秒，由此形成计算能力的天花板；若普通转账交易归集到普通区块，智能合约交易归集到合约区块，每个合约都有自己独立的状态库，这样形成两条链：转账链、合约链，矿工会按照一定的规则，在恰当的时机，将合约状态库合并（Merge）到转账链对应的状态库，完成资金清算与结算，这样能够使得 15 秒天花板获得较大的提升。
- 解决 MEV（矿工可提取价值问题）：一个区块中的交易排列顺序可被矿工操纵并利用，用户和 DeFi 合约并不关心交易顺序，所以才会存在 MEV，解决的方法是：1）对交易按照固定的规则进行排序；2）交易打包生产区块者和交易执行者分开，生产者打包区块，执行者以自己的地址与交易Hash进行异或运算，以运算结果的排序，决定区块中的交易执行顺序，交易执行者获得大部分手续费，交易打包者获得少量手续费。


