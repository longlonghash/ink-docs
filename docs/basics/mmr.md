---
title: MMR，追加与拱起的游戏
slug: /mmr
---

### MMR (Merkle Mountain Range)

在俄罗斯方块游戏中，只要界面中的小方块凑齐完整的一行，这一行就会被消除掉，游戏者和旁观者看到这一幕时会感到挺解压，心情都会很舒适、很愉悦。若我们读懂Merkle Mountain Range (MMR)的游戏规则之后，同样会感到很愉悦，只不过MMR的规则不是消除，而是不断地在追加并拱起方块。玩法如下：

初始状态是一张白纸，什么内容也没有，现在开始从白纸底部第0行追加方块

追加一个方块，在纸上记下 0
```markdown
0
```
追加一个方块：在纸上记下 1
```markdown
0   1
```
**方块0**和**方块1**都排在第0行，所以他们的高度都是0，MMR的规则设定了白纸中的任意一行只要**新出现**两个相同高度的方块，这两个方块就要拱起生成一个新的方块放置在上方，于是白纸当前的状态变为：
```markdown
  2

0   1 （0与1拱起2）
```
追加一个方块：在纸上记下 3
```markdown
  2

0   1   3
```
追加一个方块：在纸上记下 4
```markdown
      6

  2       5 （2与5拱起6）

0   1   3   4 （3与4拱起5）
```
持续追加到白纸上出现19个方块（0～18），对应的图案模式应该是：

```markdown
L3                   14

L2           6                13

L1       2       5        9        12        17

L0    0   1   3   4   7   8   10   11   15   16   18
```
节点追加与上拱的过程，就像地壳板块碰撞，持续创造出拱起的山峰一样，由此得名MMR。

### 根哈希值
从第0层开始，收集每一层最后一个落单的节点（Peak，峰顶），错层配对后接着上拱，得到：

Root = Hash(Peak14, Hash(Peak13, Hash(Peak17, Peak18)))

### 叶节点验证
在证明和验证方面，MMR和MerkleTree几乎没有差别，MerkleTree需提前固定叶子节点数量，而MMR则更加灵活，允许不断追加新叶子节点，所以MMR可显著减少从一个区块链系统递交到另一个区块链系统上的区块头数量，更容易实现跨链交互过程中的证明与验证。

### 换个角度思考
若将这19个方块按编号（0～18）依次排放到第1行，并在第2行写下每个方块所处的层次高度，可得：

```markdown
编号/index => 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18

层高/value => 0  0  1  0  0  1  2  0  0  1  0  0  1  2  3  0  0  1  0
```
若每个小方块，不依次编号，直接用其对应的高度进行表示，第0层节点计作0，第1层节点计作1，以此类推，可直接得出第2行的高度数字序列，这在本质上就是将整个层次或树结构，压缩到一个数组（向量）中：编号对应元素下标（index），层高对应元素值（value）。

```markdown

0 （追加1个，对应的结构状态）

00 => 001 （追加1个，紧接着拱起1次，对应的结构状态）

0010 （追加1个，对应的状态）

00100 => 001001 => 0010012 （追加1个，紧接着拱起2次，对应的结构状态）

00100120 （追加1个，对应的结构状态）

001001200 => 0010012001 （追加1个，紧接着拱起1次，对应的结构状态）

00100120010 （追加1个，对应的结构状态）

001001200100 => 0010012001001 => 00100120010012 => 001001200100123 （追加1个，紧接着拱起3次，对应的结构状态）

0010012001001230 （追加1个，对应的结构状态）

00100120010012300 => 001001200100123001 （追加1个，紧接着拱起1次，对应的结构状态）

0010012001001230010 （追加1个，对应的结构状态）
```
现在我们已经不难理解：若将第0层依次添加的每个方块，都看作是一个block或block_header，那么随着区块按序增长，整个区块链账本就可以用MMR表达出来。

### 参考资料

- [Grin](https://docs.grin.mw/wiki/chain-state/merkle-mountain-range)
- [OpenTimestamps](https://github.com/opentimestamps/opentimestamps-server/blob/master/doc/merkle-mountain-range.md)
