---
title: Balancer 交易等式解析
slug: /balancer1
---

Balancer 提供了 2 种以上 Token 组合交易与提供单币种流动性的功能。

<center> <img src="../picture/blancer-coordinate.png" alt="How it Works" width = "70%" height = "70%" /> </center>

<center> 3 种 Token 对应的坐标与曲面 （图片来自 Blancer 白皮书）</center>

### 用拉格朗日乘数法分析 Balancer 等式
我们举一个实际的例子来分析 Balancer 的无常损失的最低点是如何求出来的。

对两种 Token 的交易等式，有

> (X^1) \* (Y^2) = V^3，指数 1 和 2 表示权重

做一次等价变形，1 和 2 分别对应 1/3 和 2/3，可得

> (X^(1/3)) \* (Y^(2/3)) = V

为了更方便进行讲述，以下仍然采取整数形式的等式写法

> (X^1) \* (Y^2) = V^3 => X \* (Y^2) = V^3

如何发现这种交易的的无常损失的最低点呢？Balancer 白皮书采取求偏导的方法来求解最低点。

这里使用拉格朗日乘数法，可使计算过程更加清晰简单：

令 F(X,Y) = X+Y 作为我们得目标函数（因为这个函数值最小即得无常损失最低，参见 Curve 的 X+Y=K 等式），根据拉格朗日乘数法，引入

> C \* (X\*(Y^2) - V^3) = 0，C 是任意常数

对 F(X,Y) = X+Y + C\*(X\*(Y^2)-V^3) 求两个偏导数，并形成方程组
> Fx = 1 - C\*(Y^2) = 0
> 
> Fy = 1 - 2CXY = 0

可解得 Y = 2X

### Blancer，Uniswap 与黄金分割 
若 X 和 Y 的指数都是 1，那么 Balancer 的等式，就会变成 Uniswap 的 X\*Y=K 等式。但 Balancer 提供了一个很优秀的特性，用户可用单个币种取提供流动性，在这种情况下，白皮书里面提供了如下等式：
> Pissued = Psupply \* (((1 + (At/Bt))^Wt) - 1)

我们考虑 Pissued = 1，Psupply = 10，且单个币种 Bt 的权重 Wt = 1/3，可反推出 At/Bt = 1.331，这意味着单币种投入 331 Bt，才能够提供相当于同时投入 100 Bt 和 200 Bo 来为池子提供流动性，假定此时的方程式是
> Bt^(1/3) * Bo^(2/3) = V 即只有两个币种，权重分别为 1/3 和 2/3

现在思考一个问题：怎么用单一币种为 Uniswap 提供流动性？ 

Uniswap 是按比例同时投入两种币为交易池提供流动性。按照上述思路，我们也可以用一种币先兑换另一种币，然后两种币同时投入到池子中提供流动性。

假设池子里的初始配置为 100 X，100 Y，X\*Y=K=10000。

此时如果我们有 100 X 准备投入池子提供流动性，我们考虑将这 100 X 先兑换一部分 Y 币。

假设 100=m+n，m 仍是 X 币，拿来换成 Y 币，由公式 X\*Y=K 的交易等式，可得：

> 100 - 10000/(100+n) = 100-n

这导致 n*n+100n-10000=0

这个方程的解正好是 n = 61.8，就是按照黄金分割比例来分割单一币 100 为 61.8 和 38.2，就可等效于两种币各投入了 38.2，从而等效与用等比例的两种币提供流动性。

未完，待续...

